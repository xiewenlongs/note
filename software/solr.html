

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>solr &mdash; Notebook</title>
  

  
  
    <link rel="shortcut icon" href="../_static/logo.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Notebook" href="../index.html"/>
        <link rel="up" title="技术" href="index.html"/>
        <link rel="next" title="supervisord" href="supervisord.html"/>
        <link rel="prev" title="sentry" href="sentry.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> 一剑光寒起书楼
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../program_lang/index.html">编程语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">计算机网络</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">技术</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="django.html">django</a></li>
<li class="toctree-l2"><a class="reference internal" href="flask.html">flask</a></li>
<li class="toctree-l2"><a class="reference internal" href="github.html">github</a></li>
<li class="toctree-l2"><a class="reference internal" href="goaccess.html">goaccess</a></li>
<li class="toctree-l2"><a class="reference internal" href="hadoop.html">hadoop</a></li>
<li class="toctree-l2"><a class="reference internal" href="list.html">list</a></li>
<li class="toctree-l2"><a class="reference internal" href="lucene.html">lucene</a></li>
<li class="toctree-l2"><a class="reference internal" href="maven.html">maven</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongo.html">mongo</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoengine.html">mongoengine</a></li>
<li class="toctree-l2"><a class="reference internal" href="mysql.html">mysql</a></li>
<li class="toctree-l2"><a class="reference internal" href="oss.html">云存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrapy.html">scrapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="sentry.html">sentry</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">solr</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">安装</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirements">requirements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id2">介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">solr 家目录</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">下载solr</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">部署solr</a></li>
<li class="toctree-l4"><a class="reference internal" href="#schema">定义schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">solr常用命令</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">扩展</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="supervisord.html">supervisord</a></li>
<li class="toctree-l2"><a class="reference internal" href="uwsgi.html">uwsgi</a></li>
<li class="toctree-l2"><a class="reference internal" href="vim.html">vim</a></li>
<li class="toctree-l2"><a class="reference internal" href="webbench.html">webbench</a></li>
<li class="toctree-l2"><a class="reference internal" href="nginx/index.html">nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="python-lib/index.html">python库</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">linux 笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arithmetic/index.html">算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mind/index.html">思考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">一剑光寒起书楼</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">技术</a> &raquo;</li>
      
    <li>solr</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="solr">
<h1>solr<a class="headerlink" href="#solr" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>安装<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>solr 5 之前，可能需要打成solr.war包，放在tomcat里启动。solr 5以后，就不支持tomcat方式启动了</p>
<div class="section" id="requirements">
<h3>requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<table border="1" class="table-bordered docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">需求</th>
<th class="head">版本</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>java</td>
<td>1.7</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">solr 从5开始，不支持打成war包在web container里(如tomcat)运行了,  因为它自己就是一个独立的server</p>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>介绍<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>solr 家目录<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>下载solr并解压后，那个目录是solr的安装目录。解压完就相当于安装完了，之后，需要定一个 <code class="docutils literal"><span class="pre">solr</span> <span class="pre">家目录</span></code>, 用来放置多个core文件的目录</p>
<p>solr 启动的时候，必须指定家目录。 家目录有两个作用, 一是指定配置文件，二是放置index索引文件. 家目录结构一般如下:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;solr-home-directory&gt;/
|
|___solr.xml                    solr基础功能配置
|___zoo.cfg                     如果启动cloud模式，则家目录必须有这个配置(zookeeper的配置)
|___核心1/
    |____core.properties
    |
    |____conf/
    |    |__solrconfig.xml      solr高级功能配置
    |    |__stopwords.txt
    |    |__protwords.txt
    |    |__synonyms.txt
    |    |__managed-schema      功能和schema.xml类似
    |    |__elevate.xml
    |    |__currency.xml
    |    |__schema.xml          schema
    |
    |____data/
         |___index/
         |___tlog/
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">schema.xml 和 managed-schema 的功能一样，都是管理solr schema 的配置文件。具体solr使用哪个，要由solrconfig.xml里的
&lt;schemaFactory class=&#8221;ManagedIndexSchemaFactory&#8221;&gt; 标签来控制. managed-schema是允许solr动态来修改schema</p>
</div>
<p>solr 有两种模式:</p>
<div class="highlight-python"><div class="highlight"><pre>SolrCloud       collections
standalone      cores
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>使用<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>下载solr<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>在终端执行:</p>
<div class="highlight-python"><div class="highlight"><pre>wget http://archive.apache.org/dist/lucene/solr/5.0.0/solr-5.0.0.tgz -c
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>部署solr<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>为自己的项目增加solr, 分四步:</p>
<ul class="simple">
<li>定义schema. 告诉solr增加的文档怎么增加到索引中</li>
<li>安装并启动solr, 创建core</li>
<li>填充要索引的文档。 一般是把database import 到solr里</li>
<li>向用户开放搜索接口</li>
</ul>
</div>
<div class="section" id="schema">
<h3>定义schema<a class="headerlink" href="#schema" title="Permalink to this headline">¶</a></h3>
<p>SOLR加载数据，创建索引和数据时，核心数据结构的配置文件是schema.xml，该配置文件主要用于配置数据源，字段类型定义，
搜索类型定义等。schema.xml的配置直接影响搜索结果的准确性与效率。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">默认&lt;home&gt;/&lt;core&gt;/conf/solrconfig.xml 里 schemaFactory=ManagedIndexSchemaFactory, 这样的话solr使用接口管理schema,
所以conf/schema.xml并不起作用。 修改schemaFactory=ClassicIndexSchemaFactory, 然后再创造schema.xml, 并重启solr</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>要定义field, 先要定义fieldType, fieldType 告诉solr每种类型对应的底层Java类, 例如:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;fieldType name=&quot;text_general&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot;&gt;
  &lt;analyzer type=&quot;index&quot;&gt;
    &lt;tokenizer class=&quot;solr.StandardTokenizerFactory&quot;/&gt;
      &lt;filter class=&quot;solr.StopFilterFactory&quot; ignoreCase=&quot;true&quot; words=&quot;stopwords.txt&quot; /&gt;
        &lt;!-- in this example, we will only use synonyms at query time
        &lt;filter class=&quot;solr.SynonymFilterFactory&quot; synonyms=&quot;index_synonyms.txt&quot; ignoreCase=&quot;true&quot; expand=&quot;false&quot;/&gt;
        --&gt;
      &lt;filter class=&quot;solr.LowerCaseFilterFactory&quot;/&gt;
  &lt;/analyzer&gt;
  &lt;analyzer type=&quot;query&quot;&gt;
    &lt;tokenizer class=&quot;solr.StandardTokenizerFactory&quot;/&gt;
    &lt;filter class=&quot;solr.StopFilterFactory&quot; ignoreCase=&quot;true&quot; words=&quot;stopwords.txt&quot; /&gt;
    &lt;filter class=&quot;solr.SynonymFilterFactory&quot; synonyms=&quot;synonyms.txt&quot; ignoreCase=&quot;true&quot; expand=&quot;true&quot;/&gt;
    &lt;filter class=&quot;solr.LowerCaseFilterFactory&quot;/&gt;
  &lt;/analyzer&gt;
&lt;/fieldType&gt;
</pre></div>
</div>
<p>定义fieldType时，可用的属性:</p>
<table border="1" class="table-bordered docutils">
<colgroup>
<col width="22%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">属性名</th>
<th class="head">作用</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>name</td>
<td>The name of the fieldType.  This value gets used in field definitions, in the &#8220;type&#8221;
attribute.  It is strongly recommended that names consist of alphanumeric or underscore
characters only and not start with a digit. This is not currently strictly enforced.</td>
</tr>
<tr class="row-odd"><td>class</td>
<td>The class name that gets used to store and index the data for this type.  Note
that you may prefix included class names with &#8220;solr.&#8221; and Solr will automatically figure
out which packages to search for the class - so &#8220;solr.TextField&#8221; will work.  If you
are using a third-party class, you will probably need to have a fully qualified class
name.  The fully qualified equivalent for &#8220;solr.TextField&#8221; is &#8220;org.apache.solr.schema.
TextField&#8221;.</td>
</tr>
<tr class="row-even"><td>positionIncrementGap</td>
<td>For multivalued fields, specifies a distance between multiple values, which prevents
spurious phrase matches</td>
</tr>
<tr class="row-odd"><td>autoGeneratePhraseQueries</td>
<td>For text fields. If true, Solr automatically generates phrase queries for adjacent terms.
If false, terms must be enclosed in double-quotes to be treated as phrases.</td>
</tr>
<tr class="row-even"><td>docValuesFormat</td>
<td>Defines a custom DocValuesFormat to use for fields of this type. This requires that a
schema-aware codec, such as the SchemaCodecFactory has been configured in solrconfig.xml.</td>
</tr>
<tr class="row-odd"><td>postingsFormat</td>
<td>Defines a custom PostingsFormat to use for fields of this type. This requires that a
schema-aware codec, such as the SchemaCodecFactory has been configured in solrconfig.xml.</td>
</tr>
<tr class="row-even"><td>indexed</td>
<td>If true, the value of the field can be used in queries to retrieve matching documents</td>
</tr>
<tr class="row-odd"><td>stored</td>
<td>If true, the actual value of the field can be retrieved by queries</td>
</tr>
<tr class="row-even"><td>docValues</td>
<td>If true, the value of the field will be put in a column-oriented DocValues structure</td>
</tr>
<tr class="row-odd"><td>sortMissingFirst</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>sortMissingLast</td>
<td>Control the placement of documents when a sort field is not present. As of Solr 3.5,
these work for all numeric fields, including Trie and date fields.</td>
</tr>
<tr class="row-odd"><td>multiValued</td>
<td>If true, indicates that a single document might contain multiple values for this type</td>
</tr>
<tr class="row-even"><td>omitNorms</td>
<td>If true, omits the norms associated with this field (this disables length normalization
and index-time boosting for the field, and saves some memory). Defaults to true for all
primitive (non-analyzed) field types, such as int, float, data, bool, and string. Only
full-text fields or fields that need an index-time boost need norms.</td>
</tr>
<tr class="row-odd"><td>omitTermFreqAndPositions</td>
<td>If true, omits term frequency, positions, and payloads from postings for this field.
This can be a performance boost for fields that don&#8217;t require that information. It also
reduces the storage space required for the index. Queries that rely on position that
are issued on a field with this option will silently fail to find documents. This
property defaults to true for all fields that are not text fields.</td>
</tr>
<tr class="row-even"><td>omitPositions</td>
<td>Similar to omitTermFreqAndPositions but preserves term frequency information</td>
</tr>
<tr class="row-odd"><td>termVectors</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>termPositions</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>termOffsets</td>
<td>These options instruct Solr to maintain full term vectors for each document, optionally
including the position and offset information for each term occurrence in those vectors.
These can be used to accelerate highlighting and other ancillary functionality,
but impose a substantial cost in terms of index size. They are not necessary for typical
uses of Solr</td>
</tr>
<tr class="row-even"><td>required</td>
<td>Instructs Solr to reject any attempts to add a document which does not have a value for
this field. This property defaults to false.</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">各种属性的使用场景，可以参考: <a class="reference external" href="https://cwiki.apache.org/confluence/display/solr/Field+Properties+by+Use+Case">https://cwiki.apache.org/confluence/display/solr/Field+Properties+by+Use+Case</a></p>
</div>
<p>定义field 可用的属性:</p>
<table border="1" class="table-bordered docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">属性名</th>
<th class="head">作用</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>name</td>
<td>mandatory - the name for the field</td>
</tr>
<tr class="row-odd"><td>type</td>
<td>mandatory - the name of a field type from the
&lt;types&gt; fieldType section</td>
</tr>
<tr class="row-even"><td>indexed</td>
<td>true if this field should be indexed (searchable or sortable)</td>
</tr>
<tr class="row-odd"><td>stored</td>
<td>true if this field should be retrievable</td>
</tr>
<tr class="row-even"><td>docValues</td>
<td>true if this field should have doc values. Doc values are
useful for faceting, grouping, sorting and function queries. Although not
required, doc values will make the index faster to load, more
NRT-friendly and more memory-efficient. They however come with some</td>
</tr>
<tr class="row-odd"><td>limitations</td>
<td>they are currently only supported by StrField, UUIDField
and all Trie*Fields, and depending on the field type, they might
require the field to be single-valued, be required or have a default
value (check the documentation of the field type you&#8217;re interested in
for more information)</td>
</tr>
<tr class="row-even"><td>multiValued</td>
<td>true if this field may contain multiple values per document</td>
</tr>
<tr class="row-odd"><td>omitNorms:</td>
<td>(expert) set to true to omit the norms associated with
this field (this disables length normalization and index-time
boosting for the field, and saves some memory).  Only full-text
fields or fields that need an index-time boost need norms.
Norms are omitted for primitive (non-analyzed) types by default.</td>
</tr>
<tr class="row-even"><td>termVectors</td>
<td>[false] set to true to store the term vector for a given field.
When using MoreLikeThis, fields used for similarity should be
stored for best performance.</td>
</tr>
<tr class="row-odd"><td>termPositions</td>
<td>Store position information with the term vector. This will increase storage costs.</td>
</tr>
<tr class="row-even"><td>termOffsets</td>
<td>Store offset information with the term vector. This will increase storage costs.</td>
</tr>
<tr class="row-odd"><td>required</td>
<td>The field is required.  It will throw an error if the value does not exist</td>
</tr>
<tr class="row-even"><td>default</td>
<td>a value that should be used if no value is specified when adding a document.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id7">
<h3>solr常用命令<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>启动停止服务:</p>
<div class="highlight-python"><div class="highlight"><pre># 创建一个home dir, 里面必须有solr.xml, 如果想使用cloud模式，还必须有zoo.cfg
./bin/solr start -s &lt;home dir&gt;

./bin/solr status

./bin/solr stop -p &lt;port&gt;

# 健康监测
./bin/solr healthcheck -c &lt;core&gt;
</pre></div>
</div>
<p>创建core:</p>
<div class="highlight-python"><div class="highlight"><pre>./bin/solr create &lt;core name&gt;
</pre></div>
</div>
<p>查询接口:</p>
<div class="highlight-python"><div class="highlight"><pre>curl http://localhost:8983/solr/gettingstarted/select?q=video
curl http://localhost:8983/solr/core/query -d &#39;q=*:*&#39;
</pre></div>
</div>
<p>更新文档:</p>
<div class="highlight-python"><div class="highlight"><pre># 删除所有文档
curl http://localhost:8080/solr/update --data-binary &quot;&lt;delete&gt;&lt;query&gt;*:*&lt;/query&gt;&lt;/delete&gt;&quot; -H &#39;Content-type:text/xml; charset=utf-8&#39;
curl http://localhost:8080/solr/update --data-binary &quot;&lt;commit/&gt;&quot; -H &#39;Content-type:text/xml; charset=utf-8&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>扩展<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>solr 可以横向扩展，有两种方式:</p>
<ul>
<li><p class="first">cloud</p>
<p>类似于数据库的sharding 模式，把数据分布在多台server上。当一个查询来到时，先去各个机器查询结果，最后把每个机器的结果merge在一起</p>
</li>
<li><p class="first">replica</p>
<p>类似于数据库的replica模式， 一个solr节点可以sync多份，那么对每一个slave结点，都可以查询。（可能slave结点会有延迟更新的问题)</p>
</li>
</ul>
<p>优化solr的主要方式，是优化schema:</p>
<ul class="simple">
<li>set stored=&#8221;false&#8221; for all fields possible (esp large fields) when you
only need to search on the field but don&#8217;t need to return the original
value.</li>
<li>set indexed=&#8221;false&#8221; if you don&#8217;t need to search on the field, but only
return the field as a result of searching on other indexed fields.</li>
<li>remove all unneeded copyField statements</li>
<li>for best index size and searching performance, set &#8220;index&#8221; to false
for all general text fields, use copyField to copy them to the
catchall &#8220;text&#8221; field, and use that for searching.</li>
<li>For maximum indexing performance, use the ConcurrentUpdateSolrServer
java client.</li>
<li>Remember to run the JVM in server mode, and use a higher logging level
that avoids logging every request</li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="supervisord.html" class="btn btn-neutral float-right" title="supervisord" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sentry.html" class="btn btn-neutral" title="sentry" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  false
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>